# راهنمای راه‌اندازی و اجرای پروژه

این راهنما روش‌های اجرا و پیکربندی پروژه را در دو حالت محیط توسعه و محیط تولید توضیح می‌دهد. این فایل برای مخزنی نوشته شده است که از ساختار جدید شامل قالب‌های `nginx/default.conf.template`، `nginx/Dockerfile` و فایل‌های داکر به‌روز شده استفاده می‌کند.

## پیش‌نیازها

برای اجرای این پروژه، موارد زیر لازم است:

- **Docker** و **Docker Compose** برای مدیریت و اجرای کانتینرها (پیشنهاد: Docker 20.x به بالا و Compose 2.x به بالا)
- یک **نام دامنه معتبر** در صورتی که می‌خواهید در محیط تولید از HTTPS استفاده کنید.

## متغیرهای محیطی

فایل `docker-compose.yml` از چند متغیر محیطی استفاده می‌کند. قبل از اجرای پروژه، آن‌ها را در فایل `.env` یا در خط فرمان تعیین کنید:

| نام متغیر            | توضیح | مقدار نمونه |
|----------------------|-------|-------------|
| `NGINX_ENV`          | مشخص می‌کند Nginx در حالت توسعه (development) یا تولید (production) اجرا شود. | `development` یا `production` |
| `DOMAIN`             | نام دامنه برای محیط تولید. در محیط توسعه مقدار `localhost` کافی است. | `example.com` |
| `JWT_SECRET`         | کلید مخفی برای امضای توکن دسترسی (access token). | یک رشته‌ی تصادفی و طولانی |
| `JWT_REFRESH_SECRET` | کلید مخفی برای امضای توکن رفرش (refresh token). | یک رشته‌ی تصادفی و طولانی |
| `ALLOWED_ORIGINS`    | لیست دامنه‌هایی که اجازهٔ دسترسی CORS دارند (با کاما جدا کنید). | `http://localhost,http://localhost:3000` |

می‌توانید این متغیرها را در فایل `.env` در ریشهٔ پروژه قرار دهید تا به صورت خودکار توسط Docker Compose بارگذاری شوند.

---

## اجرای پروژه در محیط توسعه

در این حالت کل سرویس‌ها داخل ماشین خودتان اجرا می‌شوند و ارتباط‌ها با HTTP انجام می‌گیرد. نیازی به SSL و گواهی نیست.

1. در فایل `.env` مقادیر زیر را تنظیم کنید (مقادیر پیش‌فرض کافی است):

```env
NGINX_ENV=development
DOMAIN=localhost
JWT_SECRET=<یک رشته‌ی تصادفی>
JWT_REFRESH_SECRET=<یک رشته‌ی تصادفی>
ALLOWED_ORIGINS=http://localhost,http://localhost:3000
```

2. سپس در ریشهٔ پروژه دستور زیر را اجرا کنید:

```bash
docker compose up --build
```

این دستور سرویس‌های `mongo`، `backend`، `frontend` (برای توسعه) و `nginx` را اجرا می‌کند. پس از build، برنامه از طریق آدرس زیر در دسترس است:

- Backend API: [http://localhost/api](http://localhost/api)
- فرانت‌اند (React dev server): [http://localhost](http://localhost)

> نکته: در محیط توسعه، ارتباط روی HTTP (پورت 80) انجام می‌شود و نیازی به گواهی SSL نیست.

---

## اجرای پروژه در محیط تولید

برای اجرای پروژه روی سرور واقعی و با استفاده از HTTPS:

1. متغیرها را در `.env` یا محیط سیستم تنظیم کنید:

```env
NGINX_ENV=production
DOMAIN=<نام_دامنه_شما>
JWT_SECRET=<کلید قوی>
JWT_REFRESH_SECRET=<کلید قوی>
ALLOWED_ORIGINS=https://<نام_دامنه_شما>
```

2. دریافت گواهی SSL با Certbot:

```bash
docker compose run --rm certbot certonly --webroot --webroot-path=/var/www/certbot -d <نام_دامنه_شما>
```

3. اجرای سرویس‌ها در پس‌زمینه:

```bash
docker compose up --build -d
```

4. Certbot هر ۱۲ ساعت یک بار به طور خودکار گواهی‌ها را تمدید می‌کند.

---

## ساختار سرویس‌ها

- **mongo**: دیتابیس MongoDB 7
- **backend**: سرور Node.js/Express روی پورت 5000
- **frontend**: در حالت توسعه Dev Server React، در تولید build نهایی
- **nginx**: مدیریت درخواست‌ها و SSL termination
- **certbot**: (اختیاری) دریافت و تمدید گواهی Let’s Encrypt

---

## نکات امنیتی

- همیشه برای `JWT_SECRET` و `JWT_REFRESH_SECRET` از مقادیر طولانی و غیرقابل حدس استفاده کنید.
- در تولید، CORS را محدود به دامنهٔ واقعی خود کنید.

---

## مدیریت کاربران و تنظیمات

1. ورود با کاربر admin (در صورت ایجاد خودکار) یا ساخت کاربر جدید از API `/api/users`
2. تغییر تنظیمات از `/settings`

---

## سوال متداول

### آیا در محیط توسعه به SSL نیاز دارم؟

خیر. در محیط توسعه پروژه روی localhost یا IP لوکال اجرا می‌شود و نیازی به SSL نیست.
